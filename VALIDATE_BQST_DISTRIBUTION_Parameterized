DECLARE PROJECT STRING DEFAULT 'cacib-lsdh-dev-df';
DECLARE DATASET STRING DEFAULT 'bq_ds_lsdh_dev_ew9_bench_bl_std';
DECLARE SCALE STRING DEFAULT '10G';
DECLARE REGION STRING DEFAULT 'europe-west9';
DECLARE duplicate_count INT64;
DECLARE sql_query STRING;

-- ===================
-- 1. Count duplicates dynamically
-- ===================
SET sql_query = FORMAT("""
  SELECT COUNT(*)
  FROM (
    SELECT ss_sold_date_sk, ss_item_sk, ss_ticket_number, COUNT(*) AS dup_count
    FROM `%s.%s.store_sales_denorm_start_%s`
    GROUP BY ss_sold_date_sk, ss_item_sk, ss_ticket_number
    HAVING COUNT(*) > 1
  )
""", PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query
INTO duplicate_count;

-- ===================
-- 2. Conditional execution
-- ===================
IF duplicate_count > 0 THEN

  -- Step A: Deduplicate rows
  SET sql_query = FORMAT("""
  CREATE OR REPLACE TABLE `%s.%s.store_sales_denorm_start_%s`
  OPTIONS(location = '%s') AS
  SELECT ARRAY_AGG(t ORDER BY ss_sold_date_sk LIMIT 1)[OFFSET(0)] AS row_data
  FROM `%s.%s.store_sales_denorm_start_%s` t
  GROUP BY ss_sold_date_sk, ss_item_sk, ss_ticket_number;
  """, PROJECT, DATASET, SCALE, REGION, PROJECT, DATASET, SCALE);
  EXECUTE IMMEDIATE sql_query;

  -- Step B: Flatten row_data back to full column set
  SET sql_query = FORMAT("""
  CREATE OR REPLACE TABLE `%s.%s.store_sales_denorm_start_%s`
  OPTIONS(location = '%s') AS
  SELECT row_data.*
  FROM `%s.%s.store_sales_denorm_start_%s`;
  """, PROJECT, DATASET, SCALE, REGION, PROJECT, DATASET, SCALE);
  EXECUTE IMMEDIATE sql_query;

  -- Step C: Create audit table if not exists
  SET sql_query = FORMAT("""
  CREATE TABLE IF NOT EXISTS `%s.%s.dedup_audit_%s` (
      run_timestamp TIMESTAMP,
      dataset STRING,
      scale STRING,
      original_count INT64,
      dedup_count INT64,
      duplicates_removed INT64
  )
  OPTIONS(location = '%s');
  """, PROJECT, DATASET, SCALE, REGION);
  EXECUTE IMMEDIATE sql_query;

  -- Step D: Insert audit record
  SET sql_query = FORMAT("""
  INSERT INTO `%s.%s.dedup_audit_%s`
  SELECT
    CURRENT_TIMESTAMP() AS run_timestamp,
    '%s' AS dataset,
    '%s' AS scale,
    orig.cnt AS original_count,
    dedup.cnt AS dedup_count,
    orig.cnt - dedup.cnt AS duplicates_removed
  FROM
    (SELECT COUNT(*) AS cnt FROM `%s.%s.store_sales_denorm_start_%s`) orig,
    (SELECT COUNT(*) AS cnt FROM `%s.%s.store_sales_denorm_start_%s`) dedup;
  """, PROJECT, DATASET, SCALE, DATASET, SCALE, PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
  EXECUTE IMMEDIATE sql_query;

ELSE
  -- ===================
  -- 3. No duplicates found
  -- ===================
  SELECT "No duplicates found in " || DATASET || ".store_sales_denorm_start_" || SCALE AS message;
END IF;


-- ===================
-- COUNT start
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_start_%s`;
""", PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Insert-medium check (should return 0 rows)
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_insert_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Delete using insert-medium
-- ===================
SET sql_query = FORMAT("""
DELETE FROM `%s.%s.store_sales_denorm_start_%s` ssref
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_insert_medium_%s` ssi
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Merge delete
-- ===================
SET sql_query = FORMAT("""
MERGE INTO `%s.%s.store_sales_denorm_start_%s` a
USING `%s.%s.store_sales_denorm_insert_medium_%s` b
ON a.ss_sold_date_sk = b.ss_sold_date_sk
AND a.ss_item_sk = b.ss_item_sk
AND a.ss_ticket_number = b.ss_ticket_number
WHEN MATCHED THEN DELETE;
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Upsert counts
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_upsert_%s`;
""", PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_upsert_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Delete xsmall
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_delete_xsmall_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Delete small
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_delete_small_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Delete medium
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_delete_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;

-- ===================
-- Intersect delete_small and delete_medium
-- ===================
SET sql_query = FORMAT("""
SELECT COUNT(*)
FROM `%s.%s.store_sales_denorm_delete_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `%s.%s.store_sales_denorm_delete_small_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", PROJECT, DATASET, SCALE, PROJECT, DATASET, SCALE);
EXECUTE IMMEDIATE sql_query;
