DECLARE DATASET STRING DEFAULT 'bq_ds_lsdh_dev_ew9_bench_bl_std';
DECLARE SCALE STRING DEFAULT '10G';
DECLARE REGION STRING DEFAULT 'eu'; -- Added region parameter to specify location
DECLARE duplicate_count INT64;

-- ===================
-- 1. Count duplicates dynamically
-- ===================
EXECUTE IMMEDIATE FORMAT("""
  SELECT COUNT(*)
  FROM (
    SELECT ss_sold_date_sk, ss_item_sk, ss_ticket_number, COUNT(*) AS dup_count
    FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`
    GROUP BY ss_sold_date_sk, ss_item_sk, ss_ticket_number
    HAVING COUNT(*) > 1
  )
""", DATASET, SCALE)
INTO duplicate_count
AT LOCATION '%s'; -- Explicitly specifying the region for the query

-- ===================
-- 2. Conditional execution
-- ===================
IF duplicate_count > 0 THEN

  -- Step A: Deduplicate rows
  EXECUTE IMMEDIATE FORMAT("""
  CREATE OR REPLACE TABLE `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`
  OPTIONS(location = '%s') AS
  SELECT ARRAY_AGG(t ORDER BY ss_sold_date_sk LIMIT 1)[OFFSET(0)] AS row_data
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` t
  GROUP BY ss_sold_date_sk, ss_item_sk, ss_ticket_number;
  """, DATASET, SCALE, REGION, DATASET, SCALE)
  AT LOCATION '%s'; -- Explicitly specifying the region for the DDL statement

  -- Step B: Flatten row_data back to full column set
  EXECUTE IMMEDIATE FORMAT("""
  CREATE OR REPLACE TABLE `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`
  OPTIONS(location = '%s') AS
  SELECT row_data.*
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`;
  """, DATASET, SCALE, REGION, DATASET, SCALE)
  AT LOCATION '%s'; -- Explicitly specifying the region for the DDL statement

  -- Step C: Create audit table if not exists
  EXECUTE IMMEDIATE FORMAT("""
  CREATE TABLE IF NOT EXISTS `cacib-lsdh-dev-df.%s.dedup_audit_%s` (
      run_timestamp TIMESTAMP,
      dataset STRING,
      scale STRING,
      original_count INT64,
      dedup_count INT64,
      duplicates_removed INT64
  )
  OPTIONS(location = '%s');
  """, DATASET, SCALE, REGION)
  AT LOCATION '%s'; -- Explicitly specifying the region for the DDL statement

  -- Step D: Insert audit record
  EXECUTE IMMEDIATE FORMAT("""
  INSERT INTO `cacib-lsdh-dev-df.%s.dedup_audit_%s`
  SELECT
    CURRENT_TIMESTAMP() AS run_timestamp,
    '%s' AS dataset,
    '%s' AS scale,
    orig.cnt AS original_count,
    dedup.cnt AS dedup_count,
    orig.cnt - dedup.cnt AS duplicates_removed
  FROM
    (SELECT COUNT(*) AS cnt FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`) orig,
    (SELECT COUNT(*) AS cnt FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`) dedup;
  """, DATASET, SCALE, DATASET, SCALE, DATASET, SCALE, DATASET, SCALE)
  AT LOCATION '%s'; -- Explicitly specifying the region for the DML statement

ELSE
  -- ===================
  -- 3. No duplicates found
  -- ===================
  SELECT "No duplicates found in " || DATASET || ".store_sales_denorm_start_" || SCALE AS message;
END IF;


-- Declare parameters
DECLARE SCALE STRING DEFAULT '10G';
DECLARE DATASET STRING DEFAULT 'bq_ds_lsdh_dev_ew9_bench_bl_std';

-- ===================
-- COUNT start
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s`;
""", DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Insert-medium check (should return 0 rows)
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_insert_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Delete using insert-medium
-- ===================
EXECUTE IMMEDIATE FORMAT("""
DELETE FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_insert_medium_%s` ssi
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Merge delete
-- ===================
EXECUTE IMMEDIATE FORMAT("""
MERGE INTO `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` a
USING `cacib-lsdh-dev-df.%s.store_sales_denorm_insert_medium_%s` b
ON a.ss_sold_date_sk = b.ss_sold_date_sk
AND a.ss_item_sk = b.ss_item_sk
AND a.ss_ticket_number = b.ss_ticket_number
WHEN MATCHED THEN DELETE;
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Upsert counts
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_upsert_%s`;
""", DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_upsert_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Delete xsmall
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_delete_xsmall_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Delete small
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_delete_small_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Delete medium
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_delete_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_start_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region

-- ===================
-- Intersect delete_small and delete_medium
-- ===================
EXECUTE IMMEDIATE FORMAT("""
SELECT COUNT(*)
FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_delete_medium_%s` ssi
WHERE EXISTS (
  SELECT 1
  FROM `cacib-lsdh-dev-df.%s.store_sales_denorm_delete_small_%s` ssref
  WHERE ssi.ss_sold_date_sk = ssref.ss_sold_date_sk
    AND ssi.ss_item_sk = ssref.ss_item_sk
    AND ssi.ss_ticket_number = ssref.ss_ticket_number
);
""", DATASET, SCALE, DATASET, SCALE)
AT LOCATION '%s'; -- Explicitly specifying the region
